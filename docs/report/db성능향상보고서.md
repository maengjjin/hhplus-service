# DB ì„±ëŠ¥ ê°œì„  ë³´ê³ ì„œ

1. ì¿ í°ì¡°íšŒ
2. ìœ ì €ì¿ í° ì¡°íšŒ
3. í•œìƒí’ˆìœ¼ë¡œ ì˜µì…˜ë“¤ ì¡°íšŒ
4. ë‹¨í’ˆì˜µì…˜ ì¡°íšŒ
5. ìƒí’ˆì°¾ê¸°
6. ìœ ì €ì¡°íšŒ
7. ìŠ¤ì¼€ì¤„ëŸ¬ ê·¸ë£¹ë°”ì´ ì¡°íšŒ

ì‹œìŠ¤í…œ ë‚´ ì£¼ìš” ì¡°íšŒ ì¿¼ë¦¬ ì¤‘ ë‹¤ìŒ ì„¸ ê°€ì§€ê°€ ì„±ëŠ¥ ë³‘ëª© ê°€ëŠ¥ì„±ì´ ë†’ì€ ì¿¼ë¦¬ë¡œ ë¶„ì„ë˜ì—ˆìŠµë‹ˆë‹¤:

2. ìœ ì € ì¿ í° ì¡°íšŒ
3. í•œ ìƒí’ˆì— ëŒ€í•œ ì˜µì…˜ë“¤ ì¡°íšŒ
4. ìŠ¤ì¼€ì¤„ëŸ¬ ê·¸ë£¹ í†µê³„ ì¡°íšŒ
   ì´ ì¤‘, 1ë²ˆê³¼ 2ë²ˆì€ PKê°€ ì•„ë‹Œ ì»¬ëŸ¼ìœ¼ë¡œ ì¡°ì¸ ë° ì¡°ê±´ í•„í„°ë§ì„ ìˆ˜í–‰í•˜ê³  ìˆìœ¼ë©°,
   3ë²ˆì€ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹ í†µê³„ë¥¼ ì§‘ê³„í•˜ëŠ” ì¿¼ë¦¬ë¡œ, ê°ê°ì— ëŒ€í•´ ì¸ë±ìŠ¤ë¥¼ ì ìš©í•˜ê³  ì„±ëŠ¥ì„ ë¹„êµí•˜ì˜€ìŠµë‹ˆë‹¤.

---

#### âœ… ìœ ì € ì¿ í° ì¡°íšŒ

- ëŒ€ìƒ í…Œì´ë¸”: `user_coupon`
- ì´ ë°ì´í„° ê±´ìˆ˜: 359,765ê±´
- êµ¬ì¡°: 500ì¢… ì¿ í° Ã— ì¿ í°ë‹¹ ì•½ 360ê±´ ë°œê¸‰

##### ê³µí†µ ì‹¤í–‰ ì¿¼ë¦¬

```sql
EXPLAIN ANALYZE
SELECT * 
FROM user_coupon uc 
INNER JOIN coupon c ON uc.coupon_id = c.coupon_id
where uc.user_id = 1
and uc.coupon_id = 500;
```

##### ğŸ”¹ ì¸ë±ìŠ¤ ì ìš© ì „

```
-> Filter: ((uc.coupon_id = 500) and (uc.user_id = 1))  (cost=35762 rows=3547) (actual time=1.21..130 rows=1 loops=1)
    -> Table scan on uc  (cost=35762 rows=354656) (actual time=1.15..111 rows=359765 loops=1)
```

##### ğŸ”¹ ì¸ë±ìŠ¤ ì ìš© í›„

```sql
CREATE INDEX idx_user_coupon_user_coupon ON user_coupon(user_id, coupon_id);
```

```
-> Index lookup on uc using idx_user_coupon_user_coupon 
(user_id=1, coupon_id=500) (cost=0.35 rows=1) (actual time=0.111..0.114 rows=1 loops=1)

```

- user_idì™€ coupon_idëŠ” ê¸°ë³¸í‚¤ëŠ” ì•„ë‹ˆì§€ë§Œ, ê³ ê°ì´ ë³´ìœ í•œ ì¿ í°ì„ ì¡°íšŒí•  ë•Œ ìì£¼ ì‚¬ìš©ë˜ëŠ” ì¡°ê±´ì´ë¯€ë¡œ ë³µí•© ì¸ë±ìŠ¤ë¥¼ ì ìš©í•¨


##### ğŸ“Š ì„±ëŠ¥ ë¹„êµ ìš”ì•½


| í•­ëª©          | ì¸ë±ìŠ¤ ë¯¸ì ìš©    | ì¸ë±ìŠ¤ ì ìš©  | ê°œì„ ë„    |
| ------------- | ---------------- | ------------ | --------- |
| ì‹¤í–‰ ì‹œê°„     | 130ms            | 0.114ms      | -99.9%    |
| ë¹„ìš© (cost)   | 35,762           | 0.35         | -99.99%   |
| ì²˜ë¦¬ í–‰ ìˆ˜    | 359,765ê±´ â†’ 1ê±´ | 1ê±´          | âœ… ìµœì†Œí™” |
| ê²€ìƒ‰ ë°©ì‹     | Full Scan        | Index Lookup | âœ… ìµœì í™” |
| ë¶ˆí•„ìš”í•œ ì½ê¸° | 359,764ê±´        | 0ê±´          | âœ… ì œê±°ë¨ |

##### ğŸ” ì„±ëŠ¥ í–¥ìƒ ê³„ì‚° ê³µì‹

- **ì‹¤í–‰ ì‹œê°„ ê°ì†Œìœ¨**
  `(130 - 0.114) / 130 Ã— 100 â‰ˆ 99.91% ê°ì†Œ`
- **ë¹„ìš© ê°ì†Œìœ¨**
  `(35762 - 0.35) / 35762 Ã— 100 â‰ˆ 99.99% ê°ì†Œ`

##### ğŸ“Œê²°ë¡ 

- `user_id`ì™€ `coupon_id`ë¥¼ í•¨ê»˜ ì¡°íšŒí•˜ëŠ” ì¡°ê±´ì—ì„œëŠ”, **ë³µí•© ì¸ë±ìŠ¤(user_id, coupon_id)** ìƒì„± ì‹œ ì„±ëŠ¥ì´ ê·¹ì ìœ¼ë¡œ ê°œì„ ë¨.
- ì „ì²´ í…Œì´ë¸” ìŠ¤ìº” ëŒ€ë¹„ **ì‘ë‹µ ì†ë„ëŠ” ì•½ 99.9% ë¹¨ë¼ì§€ê³ **, **ë¶ˆí•„ìš”í•œ í–‰ ì½ê¸°ëŠ” ì œê±°**ë˜ì–´ DB ë¶€í•˜ë„ í˜„ì €íˆ ê°ì†Œí•¨.
- í•´ë‹¹ ì¿¼ë¦¬ê°€ ë¹ˆë²ˆí•  ê²½ìš°, ë³µí•© ì¸ë±ìŠ¤ëŠ” í•„ìˆ˜ì ì„.

---

### âœ… ìƒí’ˆ ì˜µì…˜ ì¡°íšŒ ì„±ëŠ¥

- ëŒ€ìƒ í…Œì´ë¸”: `product_option`
- ì´ ë°ì´í„° ê±´ìˆ˜: 300,000ê±´
- êµ¬ì¡°: 500ê°œì˜ ìƒí’ˆ Ã— ìƒí’ˆì˜µì…˜ ì•½ 1000 ~ 140ê°œ

```sql
EXPLAIN ANALYZE
SELECT * 
FROM product_option po
INNER JOIN product p ON po.product_id = p.product_id
WHERE po.product_id = 10
  AND po.option_id = 9001;
```

##### ğŸ”¹ ì‹¤í–‰ ê³„íš ë¹„êµ

| í•­ëª© | ì¸ë±ìŠ¤ ë¯¸ì ìš© (ê¸°ì¡´) | ì¸ë±ìŠ¤ ì ìš© í›„ (ê°•ì œ ì‚¬ìš© í¬í•¨) |
|------|----------------------|----------------------------------|
| Fetched Info | `Rows fetched before execution` | ë™ì¼ |
| ì˜ˆì¸¡ row ìˆ˜ | rows=1 | rows=1 |
| ì‹¤í–‰ ì‹œê°„ | `actual time=72e-6..152e-6` | `actual time=84e-6..148e-6` |
| loops        | 1íšŒ | 1íšŒ |
| ì°¨ì´ | âŒ ê±°ì˜ ì—†ìŒ | âŒ ê±°ì˜ ì—†ìŒ |


##### âš ï¸ ì„±ëŠ¥ ê°œì„ ì´ ì—†ì—ˆë˜ ì´ìœ 

1. **ì¡°íšŒ ê²°ê³¼ê°€ 1ê±´ë¿**
    - ë‹¨ì¼ ë ˆì½”ë“œ ì¡°íšŒë¡œ ì´ë¯¸ ë§¤ìš° ë¹ ë¦„ (0.0001~0.00015ì´ˆ ìˆ˜ì¤€)

2. **`option_id`ê°€ PK**
    - ì´ë¯¸ ì¸ë±ìŠ¤ ì¡´ì¬ â†’ `option_id`ë¡œ íƒìƒ‰í•˜ëŠ” ìˆœê°„ ì¸ë±ìŠ¤ íš¨ìœ¨ í™•ë³´ë¨

3. **`SELECT *` ëª¨ë“  ì»¬ëŸ¼ ì¡°íšŒ**
    - ì¸ë±ìŠ¤ëŠ” `product_id`ë§Œ í¬í•¨ â†’ ë‚˜ë¨¸ì§€ ì»¬ëŸ¼ ì¡°íšŒ ìœ„í•´ ì–´ì°¨í”¼ í…Œì´ë¸” ì ‘ê·¼ ë°œìƒ (Covering Index ì•„ë‹˜)

4. **ì˜µí‹°ë§ˆì´ì € íŒë‹¨ìƒ ì¸ë±ìŠ¤ ì‚¬ìš©í•´ë„ ì´ë“ ê±°ì˜ ì—†ìŒ**
    - ì½ëŠ” row ìˆ˜, ë¹„êµ ë²”ìœ„ê°€ ì¢ìŒ â†’ Index Lookup vs Table Access ì°¨ì´ ê±°ì˜ ì—†ìŒ


##### ğŸ“Œ ê²°ë¡ 

- `product_id + option_id` ì¡°ê±´ì´ì§€ë§Œ, `option_id` ìì²´ê°€ PKì´ê³  ê²°ê³¼ë„ 1ê±´ì´ë¼ì„œ **ì¸ë±ìŠ¤ë¥¼ ê°•ì œë¡œ ì¨ë„ ì„±ëŠ¥ í–¥ìƒì´ ë°œìƒí•˜ì§€ ì•ŠìŒ**
- **ì‹¤í–‰ ì‹œê°„ì´ ì´ë¯¸ ë§ˆì´í¬ë¡œì´ˆ ìˆ˜ì¤€**ì´ë¼ ì¸ë±ìŠ¤ ê°œì„  íš¨ê³¼ê°€ ì˜ë¯¸ ì—†ìŒ
- í–¥í›„ ìµœì í™”ê°€ í•„ìš”í•œ ê²½ìš°:
    - ì¡°íšŒ ëŒ€ìƒì´ ë§ì€ `product_id` ì¡°ê±´ë§Œ ì‚¬ìš©í•  ê²½ìš°
    - `ORDER BY`, `LIMIT`, `GROUP BY` ë“± ì„±ëŠ¥ ì˜í–¥ì„ ì£¼ëŠ” ì¿¼ë¦¬ í˜•íƒœì¼ ë•Œ ê³ ë ¤

---

### âœ… ì¸ê¸°ìƒí’ˆ ì¡°íšŒ ì§‘ê³„

##### ğŸ“Œ ì¡°íšŒ ëª©ì 

- ìµœê·¼ 3ì¼ê°„ ì£¼ë¬¸ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ì—¬,
- `product_id`ë³„ **ì´ ì£¼ë¬¸ ìˆ˜ëŸ‰(SUM)** ê¸°ì¤€ìœ¼ë¡œ **ê°€ì¥ ë§ì´ íŒ”ë¦° 5ê°œ ìƒí’ˆ**ì„ ì •ë ¬í•˜ì—¬ ì¡°íšŒ

```sql
EXPLAIN ANALYZE
SELECT product_id
FROM order_detail
WHERE create_at >= CURDATE() - INTERVAL 3 DAY
  AND create_at < CURDATE()
GROUP BY product_id
ORDER BY SUM(order_quantity) DESC
LIMIT 5;
```

##### ğŸ”¹ ì¸ë±ìŠ¤ ì ìš© ì „

```text
-> Table scan on <temporary>  (cost=2.96..2.96 rows=1) (actual time=491..492 rows=10000 loops=1)
    -> Temporary table with deduplication  (cost=0.45..0.45 rows=1) (actual time=491..491 rows=10000 loops=1)
        -> Filter: ((order_detail.create_at >= <cache>((curdate() - interval 3 day))) and (order_detail.create_at < <cache>(curdate())))  (cost=0.35 rows=1) (actual time=0.386..352 rows=400000 loops=1)
            -> Table scan on order_detail  (cost=0.35 rows=1) (actual time=0.126..297 rows=400000 loops=1)
```


##### ğŸ”¹ ì¸ë±ìŠ¤ ì ìš© í›„

```sql
CREATE INDEX idx_order_detail_create_at_product_id ON order_detail(create_at, product_id);
```

```
-> Table scan on <temporary>  (cost=2.96..2.96 rows=1) (actual time=194..195 rows=10000 loops=1)
    -> Temporary table with deduplication  (cost=0.45..0.45 rows=1) (actual time=194..194 rows=10000 loops=1)
        -> Filter: ((order_detail.create_at >= <cache>((curdate() - interval 3 day))) and (order_detail.create_at < <cache>(curdate())))  (cost=0.35 rows=1) (actual time=0.0239..138 rows=400000 loops=1)
            -> Covering index scan on order_detail using idx_order_detail_create_at_product_id  (cost=0.35 rows=1) (actual time=0.0167..96.5 rows=400000 loops=1)

```

##### ğŸ“Š ì„±ëŠ¥ ë¹„êµ ìš”ì•½

| í•­ëª©             | ì¸ë±ìŠ¤ ë¯¸ì ìš©         | ì¸ë±ìŠ¤ ì ìš© í›„         | ê°œì„  íš¨ê³¼        |
|------------------|------------------------|--------------------------|------------------|
| ì ‘ê·¼ ë°©ì‹        | Full Table Scan        | Covering Index Scan      | âœ… ë¹ ë¥¸ ë²”ìœ„ ìŠ¤ìº” |
| ì´ ì‹¤í–‰ ì‹œê°„     | ì•½ 492ms               | ì•½ 195ms                 | â¬‡ï¸ ì•½ 60% ë‹¨ì¶•   |
| í•„í„°ë§ ì²˜ë¦¬ ì‹œê°„ | 0.386..352             | 0.0239..138              | âœ… í° í­ ê°œì„      |
| ë‚´ë¶€ í…Œì´ë¸” ì²˜ë¦¬ | í•„ìš”                   | ë™ì¼                     | -                |


##### ğŸ” ì„±ëŠ¥ í–¥ìƒ ê³„ì‚° ê³µì‹

- **ì‹¤í–‰ ì‹œê°„ ê°ì†Œìœ¨**  
  `(492 - 195) / 492 Ã— 100 â‰ˆ 60.37% ê°ì†Œ`

- **í•„í„°ë§ ì²˜ë¦¬ ì‹œê°„ ê°ì†Œìœ¨**  
  `(352 - 138) / 352 Ã— 100 â‰ˆ 60.79% ê°ì†Œ`

- **ë°ì´í„° ì ‘ê·¼ ì‹œê°„ ê°ì†Œìœ¨**  
  `(297 - 96.5) / 297 Ã— 100 â‰ˆ 67.51% ê°ì†Œ`


##### ğŸ“Œ ê²°ë¡ 

- order_detail.create_at ì¡°ê±´ì´ ìì£¼ ì‚¬ìš©ë˜ê³ , product_idì™€ í•¨ê»˜ ì¡°íšŒ/ì§‘ê³„ë˜ëŠ” íŒ¨í„´ì´ë¯€ë¡œ  create_at, product_id ë³µí•© ì¸ë±ìŠ¤ë¥¼ ì ìš©í•œ ê²°ê³¼ ì•½ 60% ì´ìƒì˜ ì„±ëŠ¥ ê°œì„ ì´ í™•ì¸ë¨
- Full Table Scan â†’ Covering Index Scanìœ¼ë¡œ ë³€ê²½ë˜ì–´ I/O ë¹„ìš© ì ˆê° ë° ë¹ ë¥¸ ê²°ê³¼ ì‘ë‹µì´ ê°€ëŠ¥í•´ì§
- ì •ë ¬ ë° ì§‘ê³„ ì„±ëŠ¥ì´ ì¤‘ìš”í•œ ìŠ¤ì¼€ì¤„ëŸ¬/í†µê³„ì„± ì¿¼ë¦¬ì— ëŒ€í•´ì„œëŠ” ì ì ˆí•œ ë³µí•© ì¸ë±ìŠ¤ê°€ ë§¤ìš° íš¨ê³¼ì ì„